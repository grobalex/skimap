#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <Preferences.h>
#include <WebServer.h>
#include <FastLED.h>

// Configuration for FastLED
#define LED_PIN     21
#define NUM_LEDS    20       
CRGB leds[NUM_LEDS];

unsigned long previousMillis = 0;  // Store the last time the function was called
const long interval = 10000;  // Interval for calling the function (10 seconds)

Preferences preferences;
WebServer server(80);

const char* AP_SSID = "Skimap setup"; 
const char* apiEndpoint = "http://192.168.8.148:6000/status";


// Static IP configuration
IPAddress local_IP(192, 168, 4, 1); 
IPAddress gateway(192, 168, 4, 1);   
IPAddress subnet(255, 255, 255, 0);    

// Flag to prevent restarting AP
bool apStarted = false; 

void setup() {
    Serial.begin(9600);
    FastLED.addLeds<WS2811, LED_PIN , RGB>(leds, NUM_LEDS);
    preferences.begin("wifi-config", false);

    if (preferences.getString("ssid", "") == "") {
        Serial.println("No SSID found, starting Config AP...");
        startConfigAP();
    } else {
        connectToWiFi();
    }
}

void loop() {
    if (WiFi.status() != WL_CONNECTED && !apStarted) {
        Serial.println("WiFi disconnected, starting Config AP...");
        startConfigAP();
    }
    server.handleClient();
}

// Start the configuration access point
void startConfigAP() {
    if (apStarted) return; // Avoid re-entering AP setup

    Serial.println("Starting Access Point...");
    WiFi.mode(WIFI_AP);
    if (!WiFi.softAP(AP_SSID)) {
        Serial.println("Failed to start Access Point!");
        return;
    }
    apStarted = true;

    if (!WiFi.softAPConfig(local_IP, gateway, subnet)) {
        Serial.println("Failed to configure static IP for AP!");
        return;
    }

    IPAddress IP = WiFi.softAPIP();
    Serial.print("Access Point IP: ");
    Serial.println(IP);

    server.on("/", HTTP_GET, []() {
        Serial.println("Serving configuration page...");
        String html = "<html><body>";
        html += "<h1>Configure WiFi and Select Ski Resort</h1>";
        html += "<form action='/save' method='POST'>";
        html += "SSID: <input type='text' name='ssid'><br>";
        html += "Password: <input type='password' name='password'><br>";
        html += "<input type='submit' value='Save'></form></body></html>";
        server.send(200, "text/html", html);
    });

    server.on("/save", HTTP_POST, []() {
        String ssid = server.arg("ssid");
        String password = server.arg("password");

        preferences.putString("ssid", ssid);
        preferences.putString("password", password);

        server.send(200, "text/html", "<h1>Configuration Saved! Rebooting...</h1>");
        delay(2000);
        ESP.restart();
    });

    server.begin();
    Serial.println("Web server started.");
}

// Connect to WiFi
void connectToWiFi() {
    WiFi.mode(WIFI_STA);
    String ssid = preferences.getString("ssid");
    String password = preferences.getString("password");

    WiFi.begin(ssid.c_str(), password.c_str());
    Serial.print("Connecting to WiFi...");

    unsigned long startTime = millis();
    while (WiFi.status() != WL_CONNECTED && millis() - startTime < 10000) {
        delay(500);
        Serial.print(".");
    }

    if (WiFi.status() == WL_CONNECTED) {
        Serial.println("Connected to WiFi!");
        apStarted = false; // Reset flag, as AP is not needed now
        server.begin(); 
        unsigned long currentMillis = millis();

        // Check if 10 seconds have passed
        if (currentMillis - previousMillis >= interval) {
            // Save the last time the function was called
            previousMillis = currentMillis;

            // Call the function to update the LEDs
            runMainScript();
        }
    } else {
        Serial.println("Failed to connect to WiFi. Starting AP once.");
        apStarted = true; // Set flag to true, so the AP does not restart endlessly
    }
}

void runMainScript() {
    HTTPClient http;
    http.begin(apiEndpoint);  // Append resort parameter to API endpoint

    // Make the GET request to the API
    int httpResponseCode = http.GET();
    if (httpResponseCode == 200) {
        String payload = http.getString();
        Serial.println("API Response: " + payload);

        // Parse the JSON response
        DynamicJsonDocument doc(1024);  // Allocate memory for JSON parsing
        DeserializationError error = deserializeJson(doc, payload);

        if (error) {
            Serial.println("Failed to parse JSON: " + String(error.c_str()));
            return;
        }

        // Loop through the array of ski lifts and update the LED colors
        for (JsonObject item : doc.as<JsonArray>()) {
            int ledPosition = item["LED"];  // Retrieve LED position from the JSON response
            String status = item["status"];  // Retrieve the status (OPEN, CLOSED, etc.)

            // Adjust for 0-based index
            ledPosition -= 1;

            // Ensure the LED position is within bounds
            if (ledPosition >= 0 && ledPosition < NUM_LEDS) {
                // Debugging the LED position and status
                Serial.println("Updating LED " + String(ledPosition + 1) + " with status: " + status);

                // Set the LED color based on the status
                if (status == "OPEN") {
                    leds[ledPosition] = CRGB::Green;  // Set LED to Green for OPEN status
                } else if (status == "HOLD") {
                    leds[ledPosition] = CRGB::Yellow;  // Set LED to Yellow for HOLD status
                } else if (status == "CLOSED") {
                    leds[ledPosition] = CRGB::Red;  // Set LED to Red for CLOSED status
                } else if (status == "SCHEDULED") {
                    leds[ledPosition] = CRGB::Blue;  // Set LED to Blue for SCHEDULED status
                } else {
                    // Handle any unknown status
                    Serial.println("Unknown status: " + status);
                    leds[ledPosition] = CRGB::Black;  // Turn off the LED
                }
            } else {
                // If LED position is out of bounds, print a message
                Serial.println("Invalid LED position: " + String(ledPosition + 1));
            }
        }

        // Update the LEDs
        FastLED.show();

    } else {
        // If the HTTP request failed, print the error code
        Serial.println("Error in HTTP request. Response code: " + String(httpResponseCode));
    }

    http.end();  // End the HTTP request
}
